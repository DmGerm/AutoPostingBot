# AutoPostingBot

**AutoPostingBot** – это ASP.NET Core приложение на C# с Blazor-интерфейсом для автоматической публикации сообщений в каналы и группы Telegram через бота. Проект представляет собой веб-интерфейс для управления ботом, хранилище данных о запланированных сообщениях и группах, а также фоновую службу, которая отправляет сообщения по расписанию. Основные языки и технологии: C# (используется в бэкенде и компонентах Blazor), HTML/CSS (UI), а также конфигурация Docker. В репозитории указаны теги «telegram», «bot», «.net», что подчёркивает использование Telegram Bot API и платформы .NET. Главная цель проекта – продемонстрировать навыки разработки веб-приложения с интеграцией стороннего API и управлением базой данных.

## Архитектура проекта

Архитектура AutoPostingBot основана на многослойной модели «клиент–сервер» на платформе ASP.NET Core. Главные компоненты системы:

* **Веб-интерфейс (UI):** реализован с помощью Blazor Server и стандартных Razor-страниц. В разделе `Components/Pages` Blazor-страницы (`Home.razor`, `UsersManager.razor` и др.) обеспечивают интерактивное управление ботом и пользователями. С помощью компонентов навигации (`Navi.razor`) и макета (`MainLayout.razor`) формируется единый интерфейс приложения. Также присутствуют Razor-страницы для аутентификации и общего макета в папке `Pages` (`Login.cshtml`, `_Layout.cshtml` и др.). Пользовательский интерфейс позволяет ввести токен Telegram-бота, запустить или остановить его, добавлять и редактировать запланированные посты, а также управлять пользователями (при наличии прав администратора).

* **Логика бота (Bot Service):** реализована в папке `BotRepo`. Интерфейс `IBotService` и класс `BotService` управляют объектом `TelegramBotClient` из библиотеки *Telegram.Bot*. Сервис может запускать и останавливать бота по предоставленному токену, отслеживает состояние подключения и перенаправляет события обновлений в обработчик `UpdateHandler`.

* **Обработчик обновлений (Handlers):** класс `UpdateHandler` (папка `Handlers`) реагирует на события `MyChatMember` от Telegram. Когда бот добавлен в группу (или удалён из неё), `UpdateHandler` вызывает методы репозитория групп (`IGroupRepo`) для сохранения или удаления соответствующей группы в базе данных. Это позволяет динамически отслеживать каналы/группы, в которых бот присутствует.

* **Фоновая служба отправки сообщений (ScheduleService):** в папке `ScheduleService` есть класс `PostSchedulerService`, унаследованный от `BackgroundService`. Это бесконечный цикл, который каждые \~30 секунд проверяет в базе данных все запланированные посты (`PostsRepository.GetPostsAsync()`), сравнивает их время публикации с текущим временем и, если пора отправлять, использует клиент `TelegramBotClient` для отправки сообщений в соответствующие группы. После отправки время публикации обновляется с учётом настроенной периодичности (если указана повторяемость). Если при отправке возникает ошибка (например, группа удалена из Telegram), служба удаляет эту группу из БД через `IGroupRepo` и выводит соответствующее сообщение в консоль. Таким образом, `ScheduleService` обеспечивает автоматическое рассылание постов по расписанию без участия пользователя.

* **Слой доступа к данным:** реализован с помощью Entity Framework Core (SQLite). В папке `Data` определены два контекста: `PostsContext` хранит посты и информацию о группах (`DbSet<PostModel> Posts`, `DbSet<GroupModel> Groups`), а `UserContext` – пользователей и роли (`DbSet<UserModel> Users`, `DbSet<RoleModel> Roles`). Модели данных находятся в папке `Models`: `PostModel` (запланированный пост), `GroupModel` (информация о канале/группе), `UserModel` (пользователь) и `RoleModel` (роль пользователя). Контексты конфигурируют ключи и связи (например, связь *один-ко-многим* между группой и её постами). Пакет *Microsoft.EntityFrameworkCore.Sqlite* обеспечивает хранение данных в SQLite-файле (в репозитории присутствуют файлы `posts.db-shm`, `posts.db-wal`).

* **Репозитории:** для работы с БД выделены слои репозиториев. В папке `PostsRepository` интерфейс `IPostsRepo` и класс `PostsRepo` реализуют CRUD-операции с постами (получение списка постов, добавление, обновление, сохранение изменений). В `TelegramGroupsRepo` интерфейс `IGroupRepo` и класс `GroupRepo` управляют списком групп, добавляя новые, удаляя и получая список всех доступных групп. Репозитории используют EF-контексты и, где нужно, AutoMapper для маппинга между DTO и моделями БД.

* **Автоматическое маппирование:** папки `Mappers` и `MappingProfiles` содержат вспомогательные классы для AutoMapper. Класс `PostEntity` описывает DTO для передачи данных поста в UI, а `UserEditModel` – DTO для редактирования пользователя. Профили `PostProfile`, `UserProfile` и `PasswordHashResolver` задают правила маппинга между моделями данных и DTO (например, учёт хеширования пароля при обновлении пользователя). Это упрощает преобразование данных между слоями репозитория и UI.

* **Аутентификация и авторизация:** проект поддерживает регистрацию и вход пользователей (недавно в проект добавлена страница смены пароля и управление пользователями). Используется собственная реализация через интерфейс `IUsersRepo` (в папке `Users`), который обеспечивает поиск и обновление пользователей. В модель пользователя (`UserModel`) входят хеш и соль пароля, роль из перечисления `RoleId` (Root, Administrator, User). Для страниц Blazor применяются атрибуты `[Authorize]`, а в навигационном меню (`Navi.razor`) реализована проверка роли для отображения ссылок на администрирование пользователей. Таким образом, обычные пользователи видят только основные функции, а администраторы могут добавлять/редактировать других пользователей и управлять ролями.

Эта архитектура позволяет разделить ответственность компонентов и упростить расширение проекта. Данные о постах и группах хранятся централизованно, фоновые задачи организованы отдельно от интерфейса, а взаимодействие с Telegram реализовано через выделенный сервис.

## Техническая реализация

Технически AutoPostingBot построен с использованием следующих технологий и библиотек:

* **ASP.NET Core + Blazor Server:** веб-приложение организовано как серверный Blazor. Большая часть UI написана на C# Razor-компонентах (Blazor). Клиентские запросы обрабатываются через SignalR-соединение, что обеспечивает интерактивность без полной перезагрузки страниц.
* **Entity Framework Core (SQLite):** для хранения данных используется БД SQLite через EF Core. В проекте есть миграции базы данных (папка `Migrations`), которые последовательно создают таблицы `Posts`, `Groups`, `Users`, `Roles`. Миграции добавляют новые поля (например, `BotID` в `PostModel` для связывания постов с конкретным ботом).
* **Telegram Bot API (Telegram.Bot):** работа с Telegram реализована через официальную библиотеку *Telegram.Bot*. Библиотека предоставляет `TelegramBotClient`, используемый для получения информации о боте (`GetMe()`) и отправки сообщений (`SendMessage`). События изменения статуса бота в чатах (`OnUpdate`) обрабатываются вручную (через `UpdateHandler`).
* **AutoMapper:** для преобразования моделей между слоями данных и UI используется AutoMapper. Профили маппинга настраивают соответствие полей между классами `PostModel`, `PostEntity` и т.д. В частности, `PasswordHashResolver` автоматически генерирует и применяет хеш пароля при изменении данных пользователя.
* **Вложенные службы и DI:** проект настроен с Dependency Injection (через `Program.cs`), где сервисы `IBotService`, `IPostsRepo`, `IGroupRepo`, `IUsersRepo`, `IMapper` и `PostSchedulerService` регистрируются в контейнере. Фоновый `PostSchedulerService` запускается как `IHostedService` при старте приложения.
* **UI и навигация:** главная страница (`Home.razor`) содержит форму для ввода токена бота и управления списком запланированных постов. Остальные страницы (регистрация, изменение пароля, управление пользователями) оформлены отдельными компонентами или Razor-страницами. Навигация между разделами реализована через общий компонент `Navi.razor` и `_Layout`.
* **Контейнеризация:** в репозитории присутствуют файлы `Dockerfile` и `compose.yaml` (Docker Compose), что позволяет упаковать приложение в Docker-контейнер. Это упрощает развёртывание и демонстрирует навыки работы с контейнерами.

**Взаимодействие компонентов:** при запуске приложения пользователь авторизуется и попадает на страницу «Настройка бота». Там он вводит токен Telegram-бота, по которому `BotService` инициализируется (создаётся `TelegramBotClient` и начинается прослушивание обновлений). Когда бот добавляется в новую группу, `UpdateHandler` сохраняет ID и название группы в БД через `GroupRepo`. Фоновая служба `PostSchedulerService` в цикле опрашивает БД через `PostsRepo.GetPostsAsync()`, и для каждого поста, время которого наступило, отправляет сообщение в соответствующую группу, используя клиент бота. После отправки у поста обновляется время публикации или он помечается как завершённый. Все изменения (создание/удаление групп, изменение постов, регистрация пользователей) обрабатываются репозиториями, которые сохраняют данные в базу.

## Установка и запуск

1. **Требования:** для работы проекта нужен .NET 6+ (или выше) SDK и среда разработки (Visual Studio 2022/2023, VS Code и т.п.). Убедитесь, что установлены необходимые пакеты (они подключаются через NuGet): `Telegram.Bot`, `Microsoft.EntityFrameworkCore.Sqlite`, `AutoMapper.Extensions.Microsoft.DependencyInjection`, `Microsoft.AspNetCore.Components.Authorization` и т.д.

2. **Клонирование репозитория:** склонируйте репозиторий `DmGerm/AutoPostingBot` с GitHub или GitVerse.

3. **Настройка базы данных:** в приложении по умолчанию используется SQLite. Файл БД создаётся автоматически при первом запуске (миграции применяются при старте, так как контексты зарегистрированы). При необходимости можно поменять строку подключения в `appsettings.json` или переменных окружения.

4. **Запуск без Docker:**

   * Откройте решение `AutoPost_Bot.sln` в Visual Studio или запустите из терминала командой:

     ```
     dotnet run --project AutoPost_Bot
     ```
   * По умолчанию приложение будет доступно по адресу `https://localhost:5001` (настройки портов задаются в `appsettings.json` или по умолчанию ASP.NET Core).

5. **Запуск с Docker:**

   * Соберите образ командой:

     ```
     docker build -t autopostingbot .
     ```
   * Или используйте `docker-compose` (файл `compose.yaml`), где сервисы уже настроены. Например:

     ```
     docker-compose up
     ```
   * Приложение поднимется в контейнере, доступно по указанным в конфигурации портам (обычно `5000`/`5001`).

6. **Авторизация:**

   * После запуска перейдите в браузере на главную страницу приложения (`/`). Поскольку реализована авторизация, вам нужно войти или зарегистрироваться (страницы `/Login` и `/UserRegistration` есть в проекте). Если страницы регистрации не реализованы до конца, создайте запись пользователя непосредственно в БД (например, добавив пользователя в таблицу `Users` с ролью `Administrator`).
   * После авторизации откроется страница «Настройка бота».

7. **Настройка бота:**

   * На странице «Настройка бота» введите токен вашего Telegram-бота (его можно получить у [@BotFather](https://t.me/BotFather)) и нажмите кнопку запуска бота. Если токен валиден, бот подключится к Telegram и начнёт слушать новые группы.
   * Затем можно добавлять посты: заполнить текст, выбрать дату/время публикации, задать периодичность (через поля дней/часов/минут) и сохранить. Список постов будет сохраняться в базе и отображаться на странице.

8. **Примеры использования:**

   * **Добавление бота в группу:** после запуска бота перейдите в Telegram и добавьте его в канал или чат (это делается как обычного пользователя-бота). Как только бот получит статус администратора или участника (`member`), сервер запишет группу в базу.
   * **Создание постов:** в веб-интерфейсе добавьте несколько тестовых постов с ближайшим временем публикации. Фоновая служба (`PostSchedulerService`) их автоматически отправит в указанные группы.
   * **Смена пароля:** для любого зарегистрированного пользователя реализована страница смены пароля (`/ChangePassword`). Достаточно ввести старый и новый пароль, система проверит их корректность (минимум 8 символов, цифры, буквы).
   * **Управление пользователями (Admin):** под учётной записью администратора можно перейти на страницу «Управление пользователями» (`/usersmanager`) и добавлять/редактировать пользователей и их роли. Это позволяет расширить систему аутентификации.

## Возможности расширения и доработки

* **Дополнительные провайдеры аутентификации:** можно интегрировать сторонние OAuth-провайдеры (Google, Microsoft и т.д.) или расширить регистрационную форму для полноценной работы **ASP.NET Identity**.
* **Обработка разных типов сообщений:** сейчас бот отправляет простые текстовые сообщения. Можно добавить отправку медиа, парсинг команд от пользователей или логику взаимодействия через `Telegram.Bot` (например, отвечать на команды `/start`).
* **Улучшение интерфейса:** дизайн текущего веб-интерфейса минималистичен. Можно применить CSS-фреймворки или улучшить адаптивность.
* **Уведомления и логирование:** добавить систему уведомлений об ошибках (например, когда не удалось отправить сообщение) и более развитое логирование (в файл или внешнюю систему).
* **Масштабирование:** при увеличении нагрузки можно перейти с SQLite на более мощную СУБД (SQL Server, PostgreSQL) и вынести фоновую службу в отдельный сервис или облачный план (например, Azure WebJob).
* **Мультиязычность:** интерфейс сейчас только на русском языке. Можно внедрить локализацию для других языков с помощью ресурсов ASP.NET Core.

## Зависимости и используемые библиотеки

Проект использует следующие ключевые зависимости и пакеты:

* **.NET 6/7/8 (ASP.NET Core):** фреймворк для создания веб-приложений и служб.
* **Blazor Server:** технология создания интерактивных веб-UI на C#.
* **Telegram.Bot:** .NET клиент для Telegram Bot API, используется для связи с серверами Telegram и отправки сообщений.
* **Microsoft.EntityFrameworkCore.Sqlite:** провайдер EF Core для работы с SQLite-базой.
* **AutoMapper:** библиотека для автоматического преобразования (маппинга) между разными объектами (Model ↔ DTO).
* **Microsoft.AspNetCore.Components.Authorization:** для авторизации пользователей в Blazor.
* **Microsoft.Extensions.Hosting:** для фоновых служб (`IHostedService` / `BackgroundService`).
* **Docker (не библиотека, а среда):** файлы `Dockerfile` и `docker-compose.yaml` используются для контейнеризации приложения.
* Прочие библиотеки (System.Text.RegularExpressions, Serilog или другие пакеты для логирования можно добавить по необходимости, но в текущей версии используются стандартные возможности .NET).

Все зависимости описаны в проекте и подтягиваются при сборке. Информацию о версиях пакетов можно найти в файле проекта `AutoPost_Bot.csproj`.
